{
  "id": "ays",
  "title": "Build FO-12 fo-experience.tsx state machine",
  "description": "## Objective\n\nBuild the main state machine component for FO-12's 3-phase affirmation selection flow with check-in screens, dynamic generation, and global progress counter.\n\n## Spec Reference\n\n**Spec:** docs/projects/2026-02-16-fo-12/2026-02-16-fo-12-spec.md — Sections: \"State Machine\", \"Generation Timing\", \"Data Flow\", \"Heart Animation Transitions\"\n\n## Scope\n\n**Files to create:**\n- app/fo-12/components/fo-experience.tsx — The main state machine (largest and most complex file)\n\n## Implementation\n\nReference FO-11's fo-experience.tsx heavily but restructure for FO-12's flow:\n\n**State (OnboardingState):**\n- Steps 0-15 (16 total steps)\n- Remove: step7Data, step7Input (no Additional Context step)\n- Add: currentPhase (1|2|3), phase3Pool (string[]), phase3PoolIndex (number)\n- Keep: heart animation state, discovery inputs, discovery step data, all loved/discarded arrays\n\n**Step Mapping:**\n- Steps 0-1: Welcome (2 sub-steps, no personalized welcome)\n- Step 2: Familiarity\n- Step 3: Goal\n- Step 4: Context (LLM, skippable) — heart animation during discovery call\n- Step 5: Tone (LLM) — heart animation, then generate first batch during final heart animation\n- Step 6: Start screen (static, affirmations pre-loaded)\n- Step 7: Phase 1 card review (10 affirmations)\n- Step 8: Check-in 1 → on Continue: loading → generate batch 2\n- Step 9: Phase 2 card review (10 affirmations)\n- Step 10: Check-in 2 → on Continue: loading → generate batch 3 (dynamic size)\n- Step 11: Phase 3 card review (continuous until 30 loved)\n- Steps 12-14: Post-review (background, notifications, paywall)\n- Step 15: Completion (all 30 affirmations)\n\n**Discovery Flow (same as FO-11 but with only 2 steps):**\n- After goal (step 3): heart animation + call discovery step 4 (context)\n- If step 4 skipped: immediately call step 5 (tone)\n- If step 4 not skipped: show step 4, on continue: heart animation + call step 5\n- After tone (step 5): heart animation \"Creating your personalized affirmations...\" + generate first batch\n- When first batch ready AND heart animation complete: go to step 6 (Start)\n\n**Generation Timing:**\n- First batch (10): during heart animation after tone step, before Start screen\n- Second batch (10): after check-in 1 Continue click (show loading via isLoading prop)\n- Third batch (max(2*remaining, 20)): after check-in 2 Continue click\n- Emergency batch: during phase 3 if pool exhausted before reaching 30\n\n**Phase 3 Logic:**\n- Maintains a pool of affirmations (phase3Pool)\n- Shows cards one by one from the pool\n- Global counter: totalLovedSoFar + lovedInCurrentPhase\n- If pool empties before 30 loved: show loading → generate more → resume\n- When 30th affirmation loved: auto-advance to step 12\n\n**Key Callbacks:**\n- handleGoalContinue: same pattern as FO-11 but calls step 4 instead of 5\n- handleContextContinue: calls step 5 instead of 6\n- handleToneContinue: generates first affirmation batch (no step 7 call)\n- handlePhase1Complete: accumulate loved/discarded, advance to check-in 1\n- handleCheckin1Continue: set loading, generate batch 2, advance to phase 2\n- handlePhase2Complete: accumulate, advance to check-in 2\n- handleCheckin2Continue: set loading, generate batch 3, advance to phase 3\n- handlePhase3CardAction: love/discard, check if 30 reached, check if pool empty\n- handlePhase3RequestMore: generate emergency batch, resume\n\n## Tests\n\nVerify: npx tsc --noEmit passes\n\nDo NOT close until tests pass.",
  "status": "closed",
  "priority": 2,
  "type": "task",
  "owner": "morten@elk.dk",
  "blocked_by": [
    "54a",
    "j9w"
  ],
  "parent": "o3x",
  "acceptance_criteria": "npx tsc --noEmit passes with no errors in fo-experience.tsx",
  "created_by": "morten@elk.dk",
  "created_at": "2026-02-16T13:19:08.1231968Z",
  "updated_at": "2026-02-16T13:39:31.1595886Z",
  "closed_at": "2026-02-16T13:39:31.1595886Z",
  "closed_reason": "Built fo-experience.tsx state machine for FO-12. 16 steps (0-15) with 3-phase selection flow: welcome (0-1), familiarity (2), goal (3), context (4, skippable), tone (5), start (6), phase 1 cards (7), checkin 1 (8), phase 2 cards (9), checkin 2 (10), phase 3 continuous (11), post-review (12-14), completion (15). Heart animations during discovery, first batch generated during tone animation, batch 2/3 generated on checkin continue, emergency batch on phase 3 pool exhaustion. npx tsc --noEmit passes cleanly."
}