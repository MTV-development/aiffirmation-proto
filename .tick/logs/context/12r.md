# Epic Context: [12r] fo-09: Main Flow with E2E Test

## Relevant Code

### Files already created (by prior epics)
| File | Description |
|------|-------------|
| `app/fo-09/types.ts` | Types: `GatheringContext`, `DynamicScreenResponse` (no `reflectiveStatement`), `FirstScreenFragmentsResponse`, `FO09GenerateBatchOptions/Result`, `FIXED_OPENING_QUESTION` |
| `app/fo-09/actions.ts` | Server actions: `generateFirstScreenFragments(name, topics)`, `generateDynamicScreen(context)`, `generateAffirmationBatchFO09(options)` — no `generateSummary` |
| `app/fo-09/components/fragment-input.tsx` | FragmentInput with `mode?: 'sentences' \| 'fragments'` prop |
| `app/fo-09/components/affirmation-card.tsx` | Single card: "Love it" / "Discard" buttons |
| `app/fo-09/components/affirmation-card-flow.tsx` | Orchestrates 5 cards one-at-a-time, progress bar "N/5", calls `onComplete(loved[], discarded[])` |
| `app/fo-09/components/affirmation-summary.tsx` | Shows loved list + "I am good with these" / "I want to create more" buttons. Props: `lovedAffirmations`, `onDone`, `onMore` |
| `app/fo-09/components/*.tsx` | Copied from fo-08: step-welcome, step-familiarity, step-topics, heart-animation, step-background, step-notifications, step-paywall, step-completion |
| `src/mastra/agents/fo-09/` | Agent, affirmation-agent, index — already created |

### Files NOT yet created (this epic)
- `app/fo-09/page.tsx` — needs creating
- `app/fo-09/layout.tsx` — needs creating
- `app/fo-09/fo-09-layout-client.tsx` — needs creating
- `app/fo-09/components/fo-experience.tsx` — needs creating
- `e2e/fo-09.test.ts` — needs creating

### Key reference files
| File | Lines | Purpose |
|------|-------|---------|
| `app/fo-08/page.tsx` | 9 | Copy template: imports `FOExperience`, wraps in div |
| `app/fo-08/layout.tsx` | 5 | Copy template: imports layout client |
| `app/fo-08/fo-08-layout-client.tsx` | 15 | Copy template: finds nav node `/fo-08`, renders `TopSubmenu` |
| `app/fo-08/components/fo-experience.tsx` | 614 | Base state machine — **heavily adapt** for fo-09 |
| `e2e/fo-08.test.ts` | 907 | Base E2E test — adapt for fo-09 changes |
| `nav.config.ts` | — | Must have `/fo-09` entry for layout-client to find |

## Architecture Notes

### State Machine (fo-experience.tsx)
FO-08 uses `useState<OnboardingState>` with `currentStep: 0-11`. FO-09 extends to steps 0-12:
- **Steps 0-4**: Identical (Welcome, Name, Welcome2, Familiarity, Topics)
- **Step 5**: Dynamic discovery (same loop, but screen 1 passes `mode="sentences"` + topics, screen 2+ passes `mode="fragments"`, NO `reflectiveStatement` prop)
- **Step 6**: Generate 5 affirmations (single `generateAffirmationBatchFO09` call, not 2×10)
- **Step 7**: `<AffirmationCardFlow>` — NEW (replaces `<AffirmationReview>`)
- **Step 8**: `<AffirmationSummary>` — NEW. "done" → step 9, "more" → back to step 6 with feedback
- **Steps 9-11**: Post-review mockups (background, notifications, paywall)
- **Step 12**: Completion (shows ALL accumulated loved affirmations)

### Key State Additions (vs FO-08)
```typescript
allLovedAffirmations: string[];      // accumulated across all cycles
allDiscardedAffirmations: string[];  // accumulated across all cycles
allGeneratedAffirmations: string[];  // all ever generated (for no-repeat)
```
Remove: `reviewSummary`, `allAffirmations` (single batch), `likedAffirmations` (replaced by allLovedAffirmations)

### Data Flow for "Generate More" Cycle
1. User clicks "I want to create more" on AffirmationSummary
2. fo-experience sets `isGenerating: true`, `currentStep: 6`
3. Calls `generateAffirmationBatchFO09({ context, batchNumber, approvedAffirmations: allLovedAffirmations, skippedAffirmations: allDiscardedAffirmations })`
4. On success: stores new batch, sets `currentStep: 7` (card flow)
5. Card flow completes → merges loved/discarded into accumulated arrays → `currentStep: 8` (summary)
6. Summary shows ALL loved from all cycles

### Key Action Signatures (fo-09)
```typescript
generateFirstScreenFragments(name: string, topics: string[]): Promise<FirstScreenFragmentsResponse>
generateDynamicScreen(context: GatheringContext): Promise<DynamicScreenResponse>
generateAffirmationBatchFO09(options: FO09GenerateBatchOptions): Promise<FO09GenerateBatchResult>
// FO09GenerateBatchOptions: { context, batchNumber, approvedAffirmations, skippedAffirmations }
```

### Component Props
- `AffirmationCardFlow`: `{ affirmations: string[], onComplete: (loved[], discarded[]) => void }`
- `AffirmationSummary`: `{ lovedAffirmations: string[], onDone: () => void, onMore: () => void }`
- `FragmentInput`: adds `mode?: 'sentences' | 'fragments'` — screen 1 uses `"sentences"`, screens 2+ use `"fragments"`

## Testing Patterns

### E2E Structure (`e2e/fo-08.test.ts` pattern)
- Standalone Playwright script run via `node --import tsx e2e/fo-09.test.ts`
- Uses `chromium.launch({ headless: false })`, `e2e_test_mode` cookie
- Helper functions: `clickButton`, `waitForText`, `waitForTextContaining`, `sleep`, `waitForHeartAnimation`, `waitForThinkingToFinish`, `countFragmentChips`, `clickFragment`, `getTextareaValue`
- Debug screenshots on failure: `e2e/debug-fo09-*.png`
- TIMEOUT=120000 for AI generation
- Test is a single `async function runTest()` with try/catch/finally

### FO-09-specific test needs
- **Sentence verification (screen 1)**: check items do NOT end with "..."
- **Fragment verification (screens 2+)**: check items DO end with "..."
- **No reflective statement**: verify absence on all discovery screens
- **Card review**: "Love it" / "Discard" buttons, progress "X/5" counter
- **Summary screen**: loved list, "I am good with these" / "I want to create more" buttons
- **"I am good" flow** → background → notifications → paywall → completion

## Conventions

### Naming
- Layout client: `fo-09-layout-client.tsx` with `Fo09LayoutClient` component
- Page component: `FO09Page`
- Layout component: `Fo09Layout`
- Nav node lookup: `navTree.find((x) => x.href === '/fo-09')`
- Import paths: `'./components/fo-experience'` (relative within app/fo-09)

### State Management
- Single `useState<OnboardingState>` with `updateState(partial)` helper
- `useCallback` for all handlers
- `useEffect` for side-effect triggers (e.g., `needsDynamicFetch` flag pattern)
- Step transitions via `setState` updating `currentStep`

### Error Handling
- Spinner + error text + "Try Again" button pattern
- Console logging with `[fo-09]` prefix in actions
- Screenshots on E2E failure with descriptive names