# FO-06 Specification

**Created:** 2026-01-26
**Status:** Ready

## Braindump / introductory thoughts

Based on FO-05 but significantly simplified. The goal is to strip away complexity and focus purely on the investigative dialogue that leads to personalized affirmations.

Key insight: FO-05 has a rich, detailed investigation prompt specifying 5 dimensions (Emotional Baseline, Inner Dialogue, Needs & Longings, Believability Threshold, Life Context). FO-06 simplifies this to a single goal: understand *why* the user wants affirmations well enough to create great ones.

## Overview

FO-06 is a streamlined affirmation onboarding flow that removes unnecessary steps and focuses on a clean investigative dialogue. Users answer 2-5 questions through a fragment-assisted input interface, then receive personalized affirmations.

### Key Changes from FO-05

| Aspect | FO-05 | FO-06 |
|--------|-------|-------|
| Progress bar | 11-segment progress bar | **Removed entirely** |
| Initial steps | Welcome → Familiarity → Topic selection (many options) | **Name only** - then directly to investigation |
| Investigation screen | Reflective statement + question | **Question only** (one sentence: reflects what we know + asks what matters most now) |
| Fragment UI | 5 initial + 8 expanded fragments | **Keep as-is** |
| Investigation prompt | Rich 5-dimension specification | **Minimal** - just "2-5 iterations to understand why user wants affirmations" |
| First screen | Dynamic based on topic selection | **Fixed opening question** |
| Ready screen | Summary before affirmations | **Keep as-is** |

### Opening Question

For the first investigative screen (fixed, before we have any context):

> "What's going on in your life right now that made you seek out affirmations?"

### Name Input

Keep the name input step before investigation begins. This enables personalized affirmations.

### Ready Screen

Keep the Ready screen showing a brief summary between investigation and affirmation generation.

## Technical Requirements

### Separate Implementation

FO-06 must be a **completely separate implementation** from FO-05:

- **Agent**: `src/mastra/agents/fo-06/` (new directory)
  - `agent.ts` - Discovery agent with simplified prompt
  - `affirmation-agent.ts` - Can largely mirror FO-05
  - `summary-agent.ts` - Can largely mirror FO-05
  - `index.ts` - Exports

- **UI Components**: `app/fo-06/` (new directory)
  - `page.tsx` - Route entry
  - `components/fo-experience.tsx` - Main state container (no progress bar)
  - `components/fragment-input.tsx` - Keep fragment UI as-is
  - `components/step-dynamic.tsx` - Investigation screens
  - `components/step-ready.tsx` - Transition to affirmations
  - `components/swipe-phase.tsx` - Affirmation swiping

- **Server Actions**: `app/fo-06/actions.ts`

### KV Store & Database Seeding

Create KV values for FO-06 prompts and **actively seed the database**:

1. Add prompt templates to `src/db/seed.ts` (extend existing seed script)
2. Run `npm run db:seed` to populate KV store
3. Required KV keys (following codebase convention `versions.{agent-id}.{keyName}.{implementation}`):
   - `versions.fo-06-discovery.system.default` - System prompt for discovery agent
   - `versions.fo-06-discovery.user.default` - User prompt template
   - `versions.fo-06-affirmation.system.default` - System prompt for affirmation generation
   - `versions.fo-06-summary.system.default` - System prompt for summary agent

### End-to-End Test

Create E2E test at `e2e/fo-06.test.ts`. Base on `e2e/fo-05.test.ts` patterns.

**Run with:** `node --import tsx e2e/fo-06.test.ts`

**Key Assertions:**

1. **No progress bar**
   - Assert that no element with progress bar styling exists (`div.flex.gap-1` with 11 children)
   - Verify throughout the entire flow

2. **Simplified flow start**
   - After page load, first interactive screen is name input
   - After name input, immediately shows investigation screen (no welcome, familiarity, or topic selection)

3. **Opening question is fixed**
   - First investigation screen shows exactly: "What's going on in your life right now that made you seek out affirmations?"

4. **Question format (screens 2+)**
   - Verify question appears as single element (no separate reflective statement)
   - Question should be a complete sentence

5. **Fragment interaction**
   - Click "Inspiration" reveals 5 fragments
   - Click fragment appends to input (without "...")
   - "More Inspiration" shows 8 additional fragments
   - Next button enabled after fragment selection

6. **Dynamic screen count**
   - Minimum 2 screens, maximum 5 screens
   - Agent's `readyForAffirmations` respected within bounds

7. **Post-investigation flow**
   - Ready screen appears with summary
   - "Create My Affirmations" button works
   - Swipe phase generates and displays affirmations
   - Checkpoint, background, notifications, paywall screens appear
   - Completion screen shows saved affirmations

**Test Flow:**
```
1. Navigate to /fo-06
2. Enter name "TestUser", click Continue
3. Verify opening question text
4. Click Inspiration, select fragment, click Next
5. Loop through 2-5 dynamic screens
6. Click "Create My Affirmations"
7. Swipe through affirmations (keep 5, skip 5)
8. Click "I am good with the affirmations I chose"
9. Navigate through mockup screens
10. Verify completion screen
```

## UI Flow

```
┌─────────────────────────────────────┐
│  Name Input                         │
│                                     │
│  "What's your name?"                │
│  [Text input]                       │
│  [Continue]                         │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Screen 1: Opening Question         │
│                                     │
│  "What's going on in your life      │
│   right now that made you seek      │
│   out affirmations?"                │
│                                     │
│  [Text input]                       │
│  [Inspiration] → fragments          │
│                                     │
│  [Continue]                         │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Screens 2-5: Follow-up Questions   │
│                                     │
│  "[One sentence reflecting what     │
│   we know + asking what matters     │
│   most to understand now]"          │
│                                     │
│  [Text input]                       │
│  [Inspiration] → fragments          │
│                                     │
│  [Continue]                         │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Ready Screen                       │
│  (Summary + "Create Affirmations")  │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Swipe Phase                        │
│  (Affirmation cards)                │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Checkpoint                         │
│  (Continue or finish)               │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Background Selection (mockup)      │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Notifications (mockup)             │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Paywall (mockup)                   │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  Completion Screen                  │
│  (Affirmation list + summary)       │
└─────────────────────────────────────┘
```

## Discovery Agent Prompt (Simplified)

The investigation prompt should be minimal. Core specification:

```
You are conducting a brief investigation (2-5 exchanges) to understand
why this user wants positive affirmations. Your goal is to understand
them well enough to create very good, specific affirmations for them.

Generate a single question that:
1. Reflects what you've learned so far (in one sentence)
2. Asks what is most important to understand now

Also generate sentence-starter fragments to help them respond.
```

The agent should signal `readyForAffirmations: true` when it has enough understanding (minimum 2 screens, maximum 5).

### Agent Response Format

The discovery agent returns JSON (note: no `reflectiveStatement` field - the question itself incorporates reflection):

```json
{
  "question": "string - one sentence that reflects what we know and asks what matters most",
  "initialFragments": ["fragment1...", "fragment2...", "fragment3...", "fragment4...", "fragment5..."],
  "expandedFragments": ["fragment1...", "fragment2...", "fragment3...", "fragment4...", "fragment5...", "fragment6...", "fragment7...", "fragment8..."],
  "readyForAffirmations": false
}
```

### Screen 1 Behavior

- **Question**: Fixed opening question (not AI-generated)
- **Fragments**: AI-generated based on the opening question context (agent receives the fixed question and generates appropriate fragments)

## Edge Cases & Error Handling

### Input Validation
- **Empty input**: Next button remains disabled until user types or selects a fragment
- **Very short input** (< 10 chars): Allow but agent should still generate meaningful follow-up
- **Very long input**: Allow up to 1000 characters, truncate display if needed

### AI Generation Failures
- **Discovery agent fails**: Show error message with "Try again" button (same as FO-05)
- **Affirmation agent fails**: Show error message, allow retry
- **Summary agent fails**: Show completion screen without summary section

### Network/Timeout Issues
- **Slow response**: Show "Thinking..." indicator (same as FO-05)
- **Timeout (>30s)**: Show error with retry option

### State Recovery
- **Page refresh**: State resets (no persistence, same as FO-05)
- **Browser back button**: Not explicitly handled (standard browser behavior)

## Open Questions

None - all questions resolved.

## Deliverables Checklist

### Agents
- [ ] Create `src/mastra/agents/fo-06/agent.ts` - Simplified discovery agent
- [ ] Create `src/mastra/agents/fo-06/affirmation-agent.ts` - Affirmation generator
- [ ] Create `src/mastra/agents/fo-06/summary-agent.ts` - Summary generator
- [ ] Create `src/mastra/agents/fo-06/index.ts` - Exports

### UI Components
- [ ] Create `app/fo-06/page.tsx` - Route entry
- [ ] Create `app/fo-06/actions.ts` - Server actions
- [ ] Create `app/fo-06/components/fo-experience.tsx` - Main container (no progress bar)
- [ ] Create `app/fo-06/components/fragment-input.tsx` - Fragment input UI
- [ ] Create `app/fo-06/components/step-dynamic.tsx` - Investigation screens
- [ ] Create `app/fo-06/components/step-ready.tsx` - Transition screen
- [ ] Create `app/fo-06/components/swipe-phase.tsx` - Affirmation swiping
- [ ] Create mockup screen components (checkpoint, background, notifications, paywall, completion)

### Database
- [ ] Add FO-06 prompts to `src/db/seed.ts`
- [ ] Run `npm run db:seed` to populate KV store

### Testing
- [ ] Create `e2e/fo-06.test.ts` with all assertions
- [ ] Run E2E test and verify passing
- [ ] Manual testing of complete flow

## References

- FO-05 implementation: `src/mastra/agents/fo-05/`, `app/fo-05/`
- FO-05 spec: `docs/projects/2026-01-25-fo-05/2026-01-25-fo-05-spec.md`
- KV store docs: `docs/current/keyvaluestore-and-template-engine.md`
- E2E testing docs: `docs/current/e2e-testing.md`
