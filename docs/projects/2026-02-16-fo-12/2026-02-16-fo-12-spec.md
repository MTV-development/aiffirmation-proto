# FO-12 Specification

**Created:** 2026-02-16
**Status:** Ready for Implementation

## Overview

FO-12 replaces FO-11's open-ended affirmation review loop with a **structured 30-affirmation selection journey**. The discovery phase is reduced from FO-11's 4 steps (goal, context, tone, additional) to 2 LLM steps (context, tone) — the Additional Context step is removed. The affirmation phase is restructured into three phases with emotional check-in screens between them.

Everything outside the selection phase (post-review onboarding) remains functionally identical to FO-11, with copy changes to welcome/name/familiarity screens and the removal of both the personalized welcome step and the Additional Context discovery step.

## Flow

### Complete Step Sequence

| Step | Screen | Type | Content |
|------|--------|------|---------|
| 0 | Welcome | Static | "Welcome! Let's get to know you so we can create your personal affirmations." |
| 1 | Name | Static | "What's your name?" |
| 2 | Familiarity | Static | "Have you used affirmations before?" — 3 buttons (cosmetic only) |
| 3 | Goal | Static Q + static chips | Same as FO-11: "What's your main goal with affirmations today, [name]?" |
| 4 | Context | LLM Q + LLM fragments | Same as FO-11: LLM-adapted question, skippable |
| 5 | Tone | LLM Q + LLM single-word chips | Same as FO-11: LLM-adapted question, never skipped |
| 6 | Start | Static | Motivational screen before first affirmations + "Let's Begin" button |
| 7 | Phase 1: Card review | Interactive | 10 affirmations, Love it / Discard one by one |
| 8 | Check-in 1 | Static | Validates effort, signals refinement + "Continue" button |
| 9 | Phase 2: Card review | Interactive | 10 affirmations, Love it / Discard one by one |
| 10 | Check-in 2 | Static | Signals progress, introduces final phase + "Continue" button |
| 11 | Phase 3: Card review | Interactive | Continuous until 30 total loved, Love it / Discard one by one |
| 12-14 | Post-review | Static | Background, notifications, paywall mockups (same as FO-11) |
| 15 | Completion | Static | All 30 loved affirmations |

### Changes from FO-11

| Area | FO-11 | FO-12 |
|------|-------|-------|
| Welcome text | "The way you speak to yourself becomes the way you live!..." | "Welcome! Let's get to know you so we can create your personal affirmations." |
| Name text | "What should we call you?" | "What's your name?" |
| Personalized welcome | "Welcome, [name]! Let us get to know you..." (step 2) | **Removed** |
| Familiarity text | "How familiar are you with affirmations?" | "Have you used affirmations before?" |
| Familiarity options | "I'm new to this" / "Somewhat familiar" / "Very familiar" | "I'm new to affirmations" / "I've tried a few" / "I use them regularly" |
| Additional Context step | Step 7: optional extra context before generation | **Removed** |
| Pre-affirmation | Loading/generation screen | "Start" motivational screen |
| Batch size | 5 per batch | 10 per batch (phases 1-2), dynamic (phase 3) |
| Review loop | Open-ended: summary → "create more" | Structured: 3 phases → 30 total loved |
| Summary screen | Shows loved affirmations + "I'm good" / "create more" | **Removed** |
| Target | User decides when done | Exactly 30 loved affirmations |
| Check-in screens | None | 2 check-in screens between phases |

### Discovery Phase (Steps 0-5)

#### Step 0: Welcome — Static (text change from FO-11)

**Text:** "Welcome! Let's get to know you so we can create your personal affirmations."

#### Step 1: Name — Static (text change from FO-11)

**Text:** "What's your name?"

#### Step 2: Familiarity — Static (text + options change from FO-11)

**Text:** "Have you used affirmations before?"

**Options:**
- "I'm new to affirmations"
- "I've tried a few"
- "I use them regularly"

Cosmetic only — value not passed to agents (same as FO-11).

#### Step 3: Goal — Static Chips (unchanged from FO-11)

**Question:** "What's your main goal with affirmations today, [name]?"

Same 36-chip list, same interaction pattern. See FO-11 spec for details.

#### Step 4: Context — LLM-Adapted (unchanged from FO-11)

Same as FO-11 step 5: LLM-adapted question + fragment chips, skippable if goal answer is rich enough.

#### Step 5: Tone — LLM-Adapted (unchanged from FO-11)

Same as FO-11 step 6: LLM-adapted question + single-word chips, never skipped.

### Heart Animation Transitions

Same pattern as FO-11:
- Step 3 → Step 4 (or Step 5 if step 4 is skipped): "Thank you for sharing, [name]..."
- Step 4 → Step 5: "Thank you for sharing, [name]..."
- Step 5 → Step 6 (Start screen): "You have been doing great, [name]! We are creating your personalized affirmations."

During the final heart animation (step 5 → step 6), the first batch of 10 affirmations is generated in the background. By the time the Start screen appears, affirmations are ready.

### Start Screen (Step 6)

Replaces FO-11's generation loading screen. Displayed after affirmations are already generated.

**Headline:**
> Based on what you've shared, 10 affirmations are ready for you.

**Subheading:**
> Choose the ones that feel right for you — the ones you can actually say to yourself.

**Body:**
> Your feedback helps us refine your next set.
> Now, let's create affirmations that truly support you.

**Button:** "Let's Begin"

**Purpose:** Communicate that the user is held and guided, this is personal, something meaningful is about to happen, the user has agency, and the affirmations are created for them.

### Selection Phase 1 (Step 7)

**10 affirmations** shown one by one, Love it / Discard per card (same card UI as FO-11).

**Progress counter:** Global "X of 30 selected" counter (persistent across all three card review phases). No per-batch counter.

### Check-in 1 (Step 8)

Shown after all 10 affirmations from phase 1 are reviewed.

**Headline:**
> Thank you for going through the first affirmations.

**Body:**
> Based on your selections, we've refined your affirmations to support you even more deeply.
>
> Here are 10 new affirmations — shaped by what resonated with you.
>
> - Take your time.
> - Notice what feels true.
> - Keep building what supports you.

**Button:** "Continue"

**On Continue click:** Show loading/thinking screen while generating batch 2 (10 affirmations) using feedback from phase 1 (which were loved, which were discarded).

**Tone:** Calm, affirming, supportive. Not overly enthusiastic.

### Selection Phase 2 (Step 9)

**10 affirmations** shown one by one. Same card UI. Same global "X of 30 selected" counter.

### Check-in 2 (Step 10)

Shown after all 10 affirmations from phase 2 are reviewed.

**Headline:**
> You're almost there.

**Body:**
> You've already shaped your affirmations beautifully.
>
> To create your personal set, we'll now show affirmations in order to get 30 affirmations that resonate with you.
>
> Take your time.
> Choose what feels strong, steady, and believable.
> You're building something that is truly yours.

**Button:** "Continue"

**On Continue click:** Show loading/thinking screen while generating batch 3. Batch size = max(2 × remaining needed, 20). For example: if user loved 15 out of 20 so far, they need 15 more, so generate max(30, 20) = 30 affirmations.

**Tone:** Grounded, calm, empowering, personal, steady.

### Selection Phase 3 (Step 11)

Affirmations shown **one by one continuously** until the user has 30 total loved affirmations. No batch boundaries visible to the user — they just keep swiping.

**Progress counter:** Same global "X of 30 selected" counter as phases 1-2.

**Edge case — running out of affirmations:** If the user discards enough that the pre-generated pool is exhausted before reaching 30 loved, show a thinking/loading screen ("Generating more affirmations..."), generate another batch using full feedback context, then resume the card flow.

**Completion trigger:** Once the 30th affirmation is loved, automatically advance to post-review.

### Post-Review (Steps 12-14)

Identical to FO-11: Background selection, notifications, paywall mockups.

### Completion (Step 15)

All 30 loved affirmations displayed (same component as FO-11, just with 30 items instead of variable).

## Technical Architecture

### What Changes from FO-11

| Component | FO-11 | FO-12 |
|-----------|-------|-------|
| Welcome steps | 3 sub-steps (welcome, name, personalized welcome) | 2 sub-steps (welcome, name) — personalized welcome removed |
| Familiarity text | "How familiar are you with affirmations?" | "Have you used affirmations before?" |
| Familiarity options | "I'm new to this" / "Somewhat familiar" / "Very familiar" | "I'm new to affirmations" / "I've tried a few" / "I use them regularly" |
| Discovery steps | 4 steps: goal, context, tone, additional (steps 4-7) | 3 steps: goal, context, tone (steps 3-5) — additional removed |
| Discovery agent step numbers | Steps 5, 6, 7 | Steps 4, 5 (renumbered to match FO-12 UI) |
| Pre-affirmation screen | Loading/generation | Static "Start" screen |
| Affirmation batch size | 5 | 10 (phases 1-2), dynamic (phase 3) |
| Review flow | Open loop with summary | 3-phase structured flow |
| Summary screen | Present | Removed |
| Check-in screens | None | 2 new static screens |
| Target affirmations | User decides | Exactly 30 |
| Progress counter | Batch position (e.g., "3/5") | Global "X of 30 selected" across all phases |

### Discovery Agent

Same as FO-11 but under `fo-12` namespace. Handles LLM-adapted questions for context and tone steps only (no step 7/additional). Uses FO-12's own step numbering: step 4 (context) and step 5 (tone), with corresponding KV keys `prompt_step_4` and `prompt_step_5`.

### Affirmation Agent

Based on FO-11's affirmation agent, also under `fo-12` namespace. Key differences:
- **Batch size:** 10 instead of 5
- **Feedback context:** Accumulates across all phases (loved and discarded lists grow across phases 1-3)
- **Phase 3 dynamic generation:** Must handle generating larger batches (2× remaining needed, minimum 20)

### State Machine

The `fo-experience.tsx` state machine changes significantly:

```
Discovery: steps 0-5 (same as FO-11, minus personalized welcome)
  ↓
Start screen (step 6): static, affirmations pre-loaded
  ↓
Phase 1 (step 7): review 10 affirmations
  ↓
Check-in 1 (step 8): static
  ↓ (loading: generate batch 2 with phase 1 feedback)
Phase 2 (step 9): review 10 affirmations
  ↓
Check-in 2 (step 10): static
  ↓ (loading: generate batch 3, size = max(2× remaining, 20))
Phase 3 (step 11): continuous review until 30 loved
  ↓ (if pool exhausted: loading → generate more → resume)
Post-review (steps 12-14)
  ↓
Completion (step 15)
```

### Generation Timing

| Trigger | When | Batch size |
|---------|------|------------|
| First batch | During heart animation after tone step (before Start screen) | 10 |
| Second batch | After check-in 1 "Continue" click (loading screen) | 10 |
| Third batch | After check-in 2 "Continue" click (loading screen) | max(2 × remaining needed, 20) |
| Emergency batch | During phase 3 if pool exhausted (thinking screen) | max(2 × remaining needed, 20) |

### Data Flow

```
Step 3 (Goal):
  User answers → stored in exchanges[0]
  ↓
  Heart animation starts
  ↓ (concurrent)
  Call discovery agent for step 4 (context) with exchanges[0]
  ↓
  Agent returns { skip: true } or { skip: false, question, chips }
  ↓
Step 4 (Context) — if not skipped:
  User answers → stored in exchanges[1]
  ↓
  Heart animation starts
  ↓ (concurrent)
  Call discovery agent for step 5 (tone) with exchanges[0..1]
  ↓
Step 5 (Tone):
  User answers → stored in exchanges[1 or 2]
  ↓
  Heart animation: "Creating your personalized affirmations..."
  ↓ (concurrent)
  Generate first batch of 10 affirmations using all exchanges
  ↓
Step 6 (Start screen):
  Affirmations already loaded, user clicks "Let's Begin"
  ↓
Step 7 (Phase 1):
  Review 10 affirmations → track loved[] and discarded[]
  Global counter: "X of 30 selected"
  ↓
Step 8 (Check-in 1):
  User clicks "Continue" → loading screen
  → Generate batch 2 (10) with exchanges + loved + discarded context
  ↓
Step 9 (Phase 2):
  Review 10 affirmations → update loved[] and discarded[]
  Global counter: "X of 30 selected"
  ↓
Step 10 (Check-in 2):
  User clicks "Continue" → loading screen
  → Generate batch 3 (max(2× remaining, 20)) with full feedback
  ↓
Step 11 (Phase 3):
  Review affirmations one by one until loved.length === 30
  Global counter: "X of 30 selected"
  → If pool empty before 30: thinking screen → generate more → resume
  ↓
Steps 12-15: Post-review + Completion
```

### Exchange Structure

Simplified from FO-11 (no additional context step, so always 2 or 3 exchanges):
```typescript
// When step 4 (context) is NOT skipped (3 exchanges):
exchanges: [
  { question: "What's your main goal...", answer: { text: "Motivation" } },
  { question: "Is something going on...", answer: { text: "I have an exam..." } },
  { question: "How would you want...", answer: { text: "Calm Gentle Caring" } },
]

// When step 4 (context) IS skipped (2 exchanges):
exchanges: [
  { question: "What's your main goal...", answer: { text: "I need motivation because..." } },
  { question: "How would you want...", answer: { text: "Calm Gentle Caring" } },
]
```

### Affirmation Feedback Context

Passed to affirmation agent for batches 2+:
```typescript
{
  exchanges: [...],          // Discovery context
  batchNumber: 2,            // Which batch
  approvedAffirmations: [],  // All loved so far across all phases
  discardedAffirmations: [], // All discarded so far across all phases
}
```

## Reuse from FO-11

Components reused (copied to `app/fo-12/components/`):
- `FragmentInput` — mode="words" for tone, mode="fragments" for context
- `HeartAnimation` — identical transition pattern
- `AffirmationCard` — identical card UI (Love it / Discard)
- `StepFamiliarity` — modified text and options
- `StepGoal` — unchanged
- `StepContext` — unchanged
- `StepTone` — unchanged
- `StepBackground`, `StepNotifications`, `StepPaywall` — post-review mockups
- `StepCompletion` — modified to show 30 affirmations

### New/Modified Components

| Component | Change |
|-----------|--------|
| `fo-experience.tsx` | New state machine: 3-phase selection flow, check-in screens, no loop |
| `step-welcome.tsx` | 2 sub-steps instead of 3 (personalized welcome removed), new copy |
| `step-familiarity.tsx` | New question text and option labels |
| `step-start.tsx` | **New** — motivational screen before first affirmations |
| `step-checkin.tsx` | **New** — check-in screens between phases (parameterized for check-in 1 and 2) |
| `affirmation-card-flow.tsx` | Modified: 10-card batches, global "X of 30 selected" counter, phase 3 continuous mode |
| `step-completion.tsx` | Shows all 30 loved affirmations |
| `actions.ts` | Modified: batch size 10, dynamic batch sizing for phase 3 |
| `types.ts` | Updated types for 3-phase flow, 30-affirmation target |

## File Structure

```
app/fo-12/
  page.tsx
  layout.tsx
  fo-12-layout-client.tsx
  actions.ts                      # Server actions: generateDiscoveryStep(), generateAffirmationBatchFO12()
  types.ts                        # FO12 types
  info/
    page.tsx
  components/
    fo-experience.tsx             # Main state machine (3-phase flow)
    step-welcome.tsx              # Steps 0-1 (welcome + name, no personalized welcome)
    step-familiarity.tsx          # Step 2 (new text + options)
    step-goal.tsx                 # Step 3 (from FO-11)
    step-context.tsx              # Step 4 (from FO-11, skippable)
    step-tone.tsx                 # Step 5 (from FO-11)
    step-start.tsx                # Step 6 — NEW: motivational pre-affirmation screen
    affirmation-card-flow.tsx     # Steps 7, 9, 11: card review (phase-aware)
    affirmation-card.tsx          # Individual card (from FO-11)
    step-checkin.tsx              # Steps 8, 10 — NEW: check-in screens
    fragment-input.tsx            # From FO-11
    heart-animation.tsx           # From FO-11
    step-background.tsx           # From FO-11
    step-notifications.tsx        # From FO-11
    step-paywall.tsx              # From FO-11
    step-completion.tsx           # Step 15: all 30 loved affirmations

src/fo-12/
  index.ts                          # Re-exports ImplementationProvider, useImplementation, ImplementationSelector
  implementation-context.tsx        # ImplementationProvider + useImplementation (queries 'fo-12' namespace)
  implementation-selector.tsx       # ImplementationSelector dropdown

src/mastra/agents/fo-12/
  index.ts
  discovery-agent.ts              # Based on FO-11, own namespace, steps 4-5 only (no step 7)
  affirmation-agent.ts            # Based on FO-11, batch size 10, dynamic phase 3

src/db/seeds/
  fo-12.ts                        # KV store seeds for discovery + affirmation agents

e2e/
  fo-12.test.ts                   # E2E test
```

## Registration

### 1. Left Navigation Menu (`nav.config.ts`)

```typescript
{
  label: "FO-12",
  href: "/fo-12",
  children: [
    { label: "Demo", href: "/fo-12" },
    { label: "Info", href: "/fo-12/info" },
  ],
},
```

### 2. Overview Page (`app/overview/page.tsx`)

```typescript
{
  id: 'FO-12',
  name: 'Structured 30-Affirmation Journey',
  href: '/fo-12',
  tagline: 'Guided selection with emotional check-ins',
  description: 'Users select exactly 30 affirmations across three phases (10+10+remaining) with check-in screens between phases that validate effort and reinforce personalization. Same hybrid discovery as FO-11.',
  inputType: 'Static chips → LLM fragments → LLM single-word chips',
  outputType: 'Card curation (Love it / Discard) across 3 phases',
  highlight: '30-affirmation structured journey with check-ins',
},
```

### 3. Info Page (`app/fo-12/info/page.tsx`)

Create info page using `InfoPageWrapper` component.

## KV Store Keys

**Important:** FO-12's default prompts should be based on the **FO-11 "TrineV2" implementation** (stored in the live KV store), NOT the FO-11 default seed prompts. TrineV2 contains refined prompts that perform better. The TrineV2 prompts need to be exported from the live KV store and adapted for FO-12 (batch size 10 instead of 5, renumbered steps, no step 7).

Uses a **single `fo-12` namespace** (same pattern as FO-11's `fo-11` namespace). This is required for the implementation copy/create functionality to work across all agents.

```
# Shared info
versions.fo-12._info.default

# Discovery Agent
versions.fo-12._model_name.default                   # gpt-4o
versions.fo-12._temperature.default                   # 0.8
versions.fo-12.system.default                         # Discovery system prompt (from FO-11 TrineV2)
versions.fo-12.prompt_step_4.default                  # Step 4: context (from FO-11 TrineV2 prompt_step_5, renumbered)
versions.fo-12.prompt_step_5.default                  # Step 5: tone (from FO-11 TrineV2 prompt_step_6, renumbered)

# Affirmation Agent
versions.fo-12._model_name_affirmation.default        # gpt-4o
versions.fo-12._temperature_affirmation.default       # 0.9
versions.fo-12.system_affirmation.default             # Affirmation system prompt (from FO-11 TrineV2, adapted: batch size 10)
versions.fo-12.prompt_affirmation.default             # Initial generation prompt (from FO-11 TrineV2, adapted: 10 affirmations)
versions.fo-12.prompt_affirmation_with_feedback.default  # With feedback (from FO-11 TrineV2, adapted: 10 affirmations)
```

## Open Questions

- [ ] What happens if the user constantly gets irrelevant affirmations? Should there be an opportunity to redefine/fine-tune mid-flow? (PM flagged as undecided)

## Testing Strategy

### E2E Testing

Follow FO-11's E2E test structure. Create `e2e/fo-12.test.ts`.

**Run command:** `node --import tsx e2e/fo-12.test.ts`

**Test coverage areas:**

| Area | What to Test |
|------|-------------|
| Welcome (steps 0-1) | New text, name input, navigation (no personalized welcome step) |
| Familiarity (step 2) | New text, new option labels, button selection |
| Goal (step 3) | Same as FO-11 |
| Context (step 4) | Same as FO-11 (including skip logic) |
| Tone (step 5) | Same as FO-11 |
| Start screen (step 6) | Correct copy, "Let's Begin" button |
| Phase 1 (step 7) | 10 affirmations shown, Love it / Discard per card, progress counter |
| Check-in 1 (step 8) | Correct copy, "Continue" button, loading state |
| Phase 2 (step 9) | 10 affirmations shown, feedback-aware generation |
| Check-in 2 (step 10) | Correct copy, "Continue" button, loading state |
| Phase 3 (step 11) | Continuous until 30 loved, progress counter |
| Phase 3 edge case | Pool exhaustion → thinking screen → resume |
| Post-review (steps 12-14) | Same as FO-11 |
| Completion (step 15) | All 30 loved affirmations displayed |

### Key Test Scenarios

1. **Happy path (minimal discards):** User loves most affirmations, reaches 30 quickly in phase 3
2. **Heavy discard path:** User discards many affirmations, triggers emergency generation in phase 3
3. **Skip flow:** Brief goal answer → context shown; rich goal → context skipped
4. **Both paths produce 30:** Verify completion with both 2-exchange and 3-exchange discovery flows

## References

- FO-11 Trinev2 prompts (exported): `docs/projects/2026-02-16-fo-12/2026-02-16-fo-12-trinev2-reference.md`
- FO-11 spec: `docs/projects/2026-02-11-fo-11/2026-02-11-fo-11-spec.md`
- FO-11 UI: `app/fo-11/components/fo-experience.tsx`
- FO-11 agents: `src/mastra/agents/fo-11/`
- FO-11 seed data: `src/db/seeds/fo-11.ts`
- FO-11 implementation provider: `src/fo-11/`
- E2E testing setup: `docs/current/e2e-testing.md`
- E2E config: `docs/current/e2e/e2e-config.md`
